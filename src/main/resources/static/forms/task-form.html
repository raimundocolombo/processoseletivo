<!--
You can use this form through Camunda Tasklist
by setting the formKey of a BPMN User Task to:
embedded:/forms/task-form.html
-->
<script>

    var removeFile = function (arquivo){
      var removeValue = document.getElementById(arquivo.name);
      removeValue.value = "";
    }
    var inputedFile = function(arquivo){
      const file = document.querySelector('input[type=file]').files[0];
      var fileValue = document.getElementById(arquivo.name);
      if(file.size > 500000000){
        fileValue.value = "";
        alert("Tamanho de arquivo superior ao permitido, de 500MB");
        return;
      }
    }

</script>


<form name="taskForm" class="form-horizontal" role="form" enctype="multipart/form-data">

  <!-- read-only field -->
  <div class="form-group">
    <label for="name" class="col-sm-2 control-label">Solicitante</label>
    <div class="col-sm-10">
      <input type="text"
             name="name"
            
             cam-variable-name="solicitante"
             readonly="true"
             class="form-control" />      
    </div>
  </div>
  
  <div class="form-group">
    <label for="name" class="col-sm-2 control-label">Matricula Solicitante</label>
    <div class="col-sm-10">
      <input type="text"
             name="matriculaSolicitante"
             readonly="true"
             cam-variable-name="matriculaSolicitante"
             class="form-control" />
    </div>
  </div>
  
  <div class="form-group">
    <label for="name" class="col-sm-2 control-label">Data de Protocolo</label>
    <div class="col-sm-10">
      <!-- input type="date"
             name="dataProtocolo"
      		ng-model="dataProtocolo"
      		placeholder="dd/MM/yyyy" 
        		min="1997/01/01" max="2099/12/31"
             class="form-control"/-->
             
      <input id="dataProtocolo" type="datetime-local"
           min="1997/01/01T08:30:00" max="2099/12/31T16:30:00"
           name="dataProtocolo"
           pattern="[0-9]{2}/[0-9]{2}/[0-9]{4}T[0-9]{2}:[0-9]{2}:[0-9]{2}" class="form-control">
    </div>
  </div>
  
  <div class="form-group">
    <label for="name" class="col-sm-2 control-label">Descrição do Processo</label>
    <div class="col-sm-10">
      <input type="text"
             name="descricaoProcesso"
             cam-variable-name="descricaoProcesso"
             cam-variable-type="String"
             required
             class="form-control" />
    </div>
  </div>
  
  <div class="form-group">
    <label for="name" class="col-sm-2 control-label">Descrição Detalhada</label>
    <div class="col-sm-10">
      <textarea
             name="descricaoDetalhada"
             cam-variable-name="descricaoDetalhada"
             cam-variable-type="String"
             required
             rows="5"
             columns="50"
             class="form-control"></textarea>
    </div>
  </div>
  
  <div class="col-md-14" style="margin-top: 20px">
     <label style="font-weight: bold;"for="fileEmAnexo" class="custom-file-label" >Anexar Memorando</label>
     <div class="col-md-14" style="align-items: baseline; display: flex">

       <input id="memorando_anexoId"
              class="form-control"
              type="file"
              onchange="inputedFile(this)"
              name="memorando_anexo"
              readonly = "readonly"
              cam-max-filesize="500000000"
              cam-variable-name="memorando_anexo"
              cam-variable-type="File"
              ng-model="memorando_anexo">
       <button type="button" class="btn btn-primary" onclick="removeFile()" title="remover anexo">Limpar</button>
     </div>

   </div>
   
   
   <div class="col-md-14" style="margin-top: 20px">
     <label style="font-weight: bold;"for="fileEmAnexo" class="custom-file-label" >Anexar Ata de Aprovação CONTEC</label>
     <div class="col-md-14" style="align-items: baseline; display: flex">

       <input id="ata_aprovacao_anexoId"
              class="form-control"
              type="file"
              onchange="inputedFile(this)"
              name="ata_aprovacao_anexo"
              readonly = "readonly"
              cam-max-filesize="500000000"
              cam-variable-name="ata_aprovacao_anexo"
              cam-variable-type="File"
              ng-model="ata_aprovacao_anexo">
       <button type="button" class="btn btn-primary" onclick="removeFile()" title="remover anexo">Limpar</button>
     </div>

   </div>
   
   <div class="col-md-14" style="margin-top: 20px">
     <label style="font-weight: bold;"for="fileEmAnexo" class="custom-file-label" >Anexar Termo de Comprometimento</label>
     <div class="col-md-14" style="align-items: baseline; display: flex">

       <input id="termo_comprometimento_anexoId"
              class="form-control"
              type="file"
              onchange="inputedFile(this)"
              name="termo_comprometimento_anexo"
              readonly = "readonly"
              cam-max-filesize="500000000"
              cam-variable-name="termo_comprometimento_anexo"
              cam-variable-type="File"
              ng-model="termo_comprometimento_anexo">
       <button type="button" class="btn btn-primary" onclick="removeFile()" title="remover anexo">Limpar</button>
     </div>

   </div>
   
    <div class="col-md-14" style="margin-top: 20px">
     <label style="font-weight: bold;"for="fileEmAnexo" class="custom-file-label" >Anexar TAP - Termos de Abertura de Processo</label>
     <div class="col-md-14" style="align-items: baseline; display: flex">

       <input id="termo_abertura_anexoId"
              class="form-control"
              type="file"
              onchange="inputedFile(this)"
              name="termo_abertura_anexo"
              readonly = "readonly"
              cam-max-filesize="500000000"
              cam-variable-name="termo_abertura_anexo"
              cam-variable-type="File"
              ng-model="termo_abertura_anexo">
       <button type="button" class="btn btn-primary" onclick="removeFile()" title="remover anexo">Limpar</button>
     </div>

   </div>
   
   <div class="col-md-14" style="margin-top: 20px">
     <label style="font-weight: bold;"for="fileEmAnexo" class="custom-file-label" >Anexar Termo de Responsabilidade</label>
     <div class="col-md-14" style="align-items: baseline; display: flex">

       <input id="termo_responsabilidade_anexoId"
              class="form-control"
              type="file"
              onchange="inputedFile(this)"
              name="termo_responsabilidade_anexo"
              readonly = "readonly"
              cam-max-filesize="500000000"
              cam-variable-name="termo_responsabilidade_anexo"
              cam-variable-type="File"
              ng-model="termo_responsabilidade_anexo">
       <button type="button" class="btn btn-primary" onclick="removeFile()" title="remover anexo">Limpar</button>
     </div>

   </div>

  <script cam-script type="text/form-script">
  
	camForm.on('submit', function(evt) {

		verificaCamposObrigatorios(evt);

		var filesArray = [];

/*
		filesArray.push(memorando_anexo);
		filesArray.push(ata_aprovacao_anexo);
		filesArray.push(termo_comprometimento_anexo);
		filesArray.push(termo_abertura_anexo);
		filesArray.push(termo_responsabilidade_anexo);

		createVariableCamunda('arrayAnexos', 'Json', filesArray);
*/

		createVariableCamunda('mensagem', 'String', "O Processo foi Protocolado com Sucesso. Você receberá mais informações no decorrer da aprovação.");
		
 	}); // close camForm.on

	function verificaCamposObrigatorios(evt) {
		if (document.getElementById("dataProtocolo") != undefined && document.getElementById("dataProtocolo").value != undefined) {

			console.log("dataProtocolo preenchida !!!!");

			var dtProtocoloField = document.getElementById("dataProtocolo").value;

			createVariableCamunda('dataProtocolo', 'Date', dtProtocoloField);
/*
			if ($scope.memorando_anexo != undefined) {
				if ($scope.ata_aprovacao_anexo != undefined) {
					
					createVariableCamunda('dataProtocolo', 'Date', $scope.dataProtocolo);
				} else {
					alert("Ata de Aprovação obrigatória.");
					evt.submitPrevented = true;
				}
			} else {
				alert("Memorando obrigatório.");
				evt.submitPrevented = true;
			}
*/
      		
    	} else {
      		alert("Data do Protocolo obrigatória.");
      		evt.submitPrevented = true;
    	}
	}

	$scope.uploadAnexo = function() {
		document.getElementById('memorando_anexo').value = '';
	}

	$scope.uploadAnexo = function() {

	try{
      var indexOfUploadFileField = 0;

		alert('camForm.fields.length: '+camForm.fields.length);

    	for (var i = camForm.fields.length -1; i>=0; i--) {

			alert('camForm.fields[i].variableName: '+camForm.fields[i].variableName);

      		if (camForm.fields[i].variableName == 'memorando_anexo') {

				alert('camForm.fields[i].element.context: '+camForm.fields[i].element.value);
				
                if (camForm.fields[i].element.context.value == '') {
                    camForm.fields.splice(indexOfUploadFileField, 1);
                    camForm.variableManager.destroyVariable('memorando_anexo');
                }
            }
    	} // close for loop
    } catch(err) {
      console.error("Erro ao criar documento no Camunda.")
      console.error(err);
    }

   }

   function createVariableCamunda(nameVariable, typeVariable, valueVariable) {
        if (camForm.variableManager.variable(nameVariable) == undefined) {
      		console.log("Variavel "+nameVariable+" NÃO existe.");
      		console.log("createVariableCamunda - valueVariable: "+valueVariable);
          camForm.variableManager.createVariable({
              name: nameVariable,
              type: typeVariable,
              value: valueVariable,
              isDirty: true
          });
        } else {
      		console.log("Variavel "+nameVariable+" JÁ EXISTE.");
        }
    }


  </script>
  
    
</form>
